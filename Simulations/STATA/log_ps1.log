---------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/jialiang/Documents/StudyNotes/Econometrics-notes/simu-MC-methods/STATA/log_ps1.
> log
  log type:  text
 opened on:  16 Sep 2022, 21:00:48

. clear all;

. *model
> U0, U1, UV N(mu,Sigma)
> ;
. **********************************************;
. *Step 0: set model parameters;
. **********************************************;
. local sigma_u0 = 1;

.  *Standard deviations;
. local sigma_u1 = 1;

. local sigma_uv = 1;

. local corr_u01 = 0.25;

.  *correlations;
. local corr_u0v = -0.25;

. local corr_u1v = 0.5;

. local alpha = 1;

. local beta1 = 2;

. local muV = 1;

. **********************************************;
. *Step 1: generate u0, u1, uv, X, Z random variables;
. **********************************************;
. set seed 115;

. matrix C = (1, `corr_u01', `corr_u0v' \ `corr_u01', 1, `corr_u1v' \ `corr_u0v', `corr_u1v', 1);

. matrix sd = (`sigma_u0',`sigma_u1',`sigma_uv');

. drawnorm U0 U1 UV, n(10000) corr(C) sds(sd);
(obs 10,000)

. set obs 10000;
Number of observations (_N) was 10,000, now 10,000.

. gen X = runiform(0,1);

. gen Z = runiform(-2,2);

. *check descriptive stats--does this match our parameters?;
. sum U0 U1 UV X Z;

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          U0 |     10,000   -.0065739    1.000427  -3.815666    3.73557
          U1 |     10,000   -.0042142    1.002581  -3.394629   3.850077
          UV |     10,000    .0104793    .9913261  -4.147261   3.674772
           X |     10,000    .4996684     .285983   .0001617   .9999477
           Z |     10,000   -.0025573    1.146079  -1.999481    1.99974

. correlate U0 U1 UV;
(obs=10,000)

             |       U0       U1       UV
-------------+---------------------------
          U0 |   1.0000
          U1 |   0.2607   1.0000
          UV |  -0.2447   0.4979   1.0000


. * Plot Conditional ATE
> gen ATE_X = 1 - 0.25 * X
> graph twoway line ATE_X X 
> 
> **********************************************;
. *Step 2: generate V, Y0, Y1, Delta variables;
. **********************************************;
. gen V = `muV' + 1*Z + UV;

. gen Y0 = `beta1' + 0.5 * X + U0;

. gen Y1 = `beta1' + `alpha' + 0.25 * X + U1;

. gen Delta = Y1 - Y0;

. sum Y0 Y1;

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          Y0 |     10,000     2.24326     1.01065   -1.72426   6.208611
          Y1 |     10,000    3.120703    1.005518   -.179432   6.890208

. *distribution of treatment effects;
. sum Delta, detail;

                            Delta
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -1.898577      -3.681073
 5%    -1.121019      -3.271431
10%    -.6765695      -3.234683       Obs              10,000
25%     .0569031      -3.158612       Sum of wgt.      10,000

50%     .8673014                      Mean           .8774426
                        Largest       Std. dev.      1.219593
75%     1.710053       5.265991
90%     2.436531       5.509124       Variance       1.487406
95%     2.907539       5.652416       Skewness       .0380616
99%     3.722736       6.240367       Kurtosis       2.980907

. **********************************************;
. *Step 3: treatment assignment;
. **********************************************;
. *Model 1: Treatment non-randomly assigned;
. gen D = 1 if V >= 0;
(2,638 missing values generated)

. replace D = 0 if V < 0;
(2,638 real changes made)

. gen Y = D*Y1 + (1-D)*Y0;

.  *observed Y;
. * Compute ATE, ATET and ATEU using simulation draws
> sum Delta //This gives ATE
> bysort D: sum Delta // This gives ATET and ATEU
> 
> eststo clear
> *ols;
. regress Y D X;

      Source |       SS           df       MS      Number of obs   =    10,000
-------------+----------------------------------   F(2, 9997)      =    740.26
       Model |  1443.97814         2  721.989069   Prob > F        =    0.0000
    Residual |  9750.26965     9,997  .975319561   R-squared       =    0.1290
-------------+----------------------------------   Adj R-squared   =    0.1288
       Total |  11194.2478     9,999  1.11953673   Root MSE        =    .98758

------------------------------------------------------------------------------
           Y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           D |   .8377114   .0224102    37.38   0.000      .793783    .8816399
           X |   .3222786   .0345352     9.33   0.000     .2545827    .3899745
       _cons |   2.258938   .0258983    87.22   0.000     2.208172    2.309704
------------------------------------------------------------------------------

. eststo nonrandom;

. *Model 2: Treatment randomly assigned;
. set seed 115;

. gen coin = runiform();

. gen D_rand = 1 if coin > 0.5;
(4,902 missing values generated)

. replace D_rand = 0 if coin <= 0.5;
(4,902 real changes made)

. gen Y_rand = D_rand*Y1 + (1-D_rand)*Y0;

.  *observed Y;
.  *ols;
. regress Y_rand D_rand X;

      Source |       SS           df       MS      Number of obs   =    10,000
-------------+----------------------------------   F(2, 9997)      =    980.17
       Model |  1992.76192         2  996.380962   Prob > F        =    0.0000
    Residual |  10162.3228     9,997  1.01653724   R-squared       =    0.1639
-------------+----------------------------------   Adj R-squared   =    0.1638
       Total |  12155.0848     9,999  1.21563004   Root MSE        =    1.0082

------------------------------------------------------------------------------
      Y_rand | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
      D_rand |   .8611989   .0201688    42.70   0.000     .8216641    .9007338
           X |   .4059566   .0352572    11.51   0.000     .3368454    .4750677
       _cons |   2.042396   .0227174    89.90   0.000     1.997865    2.086927
------------------------------------------------------------------------------

. eststo random;

. * esttab nonrandom random using ps-1-q2.tex;
. *plot ATE
> kdensity Delta
> 
> log close
> 
> 
> 
> 
> 
> 
> 

end of do-file

. exit, clear
